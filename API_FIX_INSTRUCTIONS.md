# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å API –∏ Google Sheets

## –ü—Ä–æ–±–ª–µ–º–∞
Nginx **–ù–ï –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–ª** –∑–∞–ø—Ä–æ—Å—ã `/api/*` –Ω–∞ –±—ç–∫–µ–Ω–¥! –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω –ø—ã—Ç–∞–ª—Å—è –Ω–∞–π—Ç–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª 404.

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`deploy-git.sh`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `proxy_pass` –¥–ª—è `/api/` ‚Üí `http://127.0.0.1:8000/api/`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ `/var/log/nginx/api-access.log`

### 2. API —Å–µ—Ä–≤–µ—Ä (`api_server.py`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –í–∫–ª—é—á–µ–Ω—ã access logs –≤ uvicorn

### 3. Uvicorn –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`main.py`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è (`forwarded_allow_ips="*"`, `proxy_headers=True`)

## –®–∞–≥–∏ –¥–ª—è –¥–µ–ø–ª–æ—è

### 1. –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (–æ–±–Ω–æ–≤–∏—Ç Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é)
```bash
./deploy-git.sh deploy
```

### 2. –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –±—ç–∫–µ–Ω–¥
```bash
./bot/deploy-bot.sh
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
ssh root@217.198.5.230
cd /var/www/illariooo.ru/bot
pm2 restart barcelona-bots --update-env
pm2 logs barcelona-bots --lines 50
```

### 4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ Nginx
```bash
ssh root@217.198.5.230
nginx -t  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
systemctl reload nginx
```

### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
```bash
# –õ–æ–≥–∏ API —Å–µ—Ä–≤–µ—Ä–∞
pm2 logs barcelona-bots --lines 100

# –õ–æ–≥–∏ Nginx –¥–ª—è API
tail -f /var/log/nginx/api-access.log
tail -f /var/log/nginx/api-error.log

# –û–±—â–∏–µ –ª–æ–≥–∏ Nginx
tail -f /var/log/nginx/illariooo.ru-access.log
tail -f /var/log/nginx/illariooo.ru-error.log
```

### 6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É API –Ω–∞–ø—Ä—è–º—É—é
```bash
# –° —Å–µ—Ä–≤–µ—Ä–∞
curl -X POST http://127.0.0.1:8000/api/offer-confirmation \
  -H "Content-Type: application/json" \
  -d '{"first_name":"Test","last_name":"User","email":"test@test.com","payment_type":"tariff_1_rub"}'

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: {"success":true,"confirmation_id":...,"message":"Offer confirmation saved successfully"}
```

### 7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (DevTools)
1. –û—Ç–∫—Ä–æ–π—Ç–µ `https://illariooo.ru/how-it-works?debug=1`
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ
3. –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏ —Å `debugLog`
4. –í Network tab –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω –∑–∞–ø—Ä–æ—Å –∫ `/api/offer-confirmation` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 200

## –ß—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. ‚úÖ –ó–∞–ø—Ä–æ—Å—ã —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–æ—Ö–æ–¥—è—Ç –¥–æ API —Å–µ—Ä–≤–µ—Ä–∞
2. ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
3. ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Google Sheets
4. ‚úÖ –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω—ã –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã
5. ‚úÖ –í –∞–¥–º–∏–Ω–∫–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –ª–∏–¥—ã

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –≤—Å–µ –µ—â–µ –Ω–µ –¥–æ—Ö–æ–¥—è—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω:**
   ```bash
   pm2 list
   pm2 logs barcelona-bots
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8000:**
   ```bash
   netstat -tlnp | grep 8000
   # –∏–ª–∏
   ss -tlnp | grep 8000
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:**
   ```bash
   nginx -t
   cat /etc/nginx/sites-available/illariooo.ru | grep -A 20 "location /api/"
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Nginx:**
   ```bash
   tail -f /var/log/nginx/api-error.log
   ```

5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –¥–æ—Ö–æ–¥—è—Ç –¥–æ Nginx:**
   ```bash
   tail -f /var/log/nginx/api-access.log
   ```

### –ï—Å–ª–∏ Google Sheets –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```bash
   pm2 env barcelona-bots | grep GOOGLE
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ credentials:**
   ```bash
   ls -la /var/www/illariooo.ru/bot/credentials.json
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
   ```bash
   pm2 logs barcelona-bots | grep -i "google\|sheets"
   ```

## –í–∞–∂–Ω–æ!

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞** –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –∫–æ–¥!
