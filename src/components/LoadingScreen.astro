---
// Loading Screen Component
// Shows only in Telegram Mini App or optionally in browser
// Auto-hides after page load to avoid SEO impact
interface Props {
  showInBrowser?: boolean; // Show in regular browser (default: false for SEO)
}

const { showInBrowser = false } = Astro.props;
---

<div id="loading-screen" class="loading-screen" data-show-in-browser={showInBrowser}>
  <div class="loading-content">
    <!-- Animated gradient circle -->
    <div class="loading-logo">
      <div class="loading-circle">
        <div class="loading-circle-inner"></div>
      </div>
      <div class="loading-pulse"></div>
    </div>
    
    <!-- Loading text with gradient -->
    <div class="loading-text">
      <span class="gradient-text">AI Model 2.0</span>
    </div>
    
    <!-- Subtle loading dots -->
    <div class="loading-dots">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
  </div>
  
  <!-- Background gradient animation -->
  <div class="loading-bg"></div>
</div>

<style is:global>
  /* CRITICAL: Prevent white flash - ensure body/html have dark background immediately */
  html, body {
    background-color: #0a0a0a !important;
  }
  
  /* CRITICAL: High specificity to override any global styles */
  #loading-screen.loading-screen,
  div#loading-screen.loading-screen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100vh !important;
    height: 100dvh !important; /* Dynamic viewport height for mobile */
    background: #0a0a0a !important;
    background-color: #0a0a0a !important; /* CRITICAL: Prevent white flash */
    z-index: 99999 !important;
    display: flex !important;
    align-items: center !important;
    pointer-events: none !important; /* Allow clicks to pass through when hidden */
    justify-content: center !important;
    opacity: 1 !important;
    visibility: visible !important;
    transition: opacity 0.5s ease-out, visibility 0.5s ease-out !important;
    /* Hide by default in browser for SEO */
    display: none !important;
  }
  
  /* Show only in Telegram Mini App by default */
  body.tg-webapp #loading-screen.loading-screen,
  body.tg-webapp div#loading-screen.loading-screen {
    display: flex !important;
  }
  
  /* Optionally show in browser if data-show-in-browser="true" */
  #loading-screen.loading-screen[data-show-in-browser="true"],
  div#loading-screen.loading-screen[data-show-in-browser="true"] {
    display: flex !important;
  }
  
  /* High specificity for loaded state */
  #loading-screen.loading-screen.loaded,
  div#loading-screen.loading-screen.loaded {
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
    display: none !important;
    z-index: -1 !important;
  }
  
  /* Ensure main-content is always above loading screen when loader is hidden */
  #main-content {
    position: relative;
    z-index: 1;
  }
  
  body.tg-webapp #main-content {
    z-index: 1;
  }
  
  /* Show only in Telegram Mini App by default */
  body.tg-webapp #loading-screen.loading-screen,
  body.tg-webapp div#loading-screen.loading-screen {
    display: flex !important;
    pointer-events: auto !important; /* Allow interaction when visible */
  }
  
  /* Optionally show in browser if data-show-in-browser="true" */
  #loading-screen.loading-screen[data-show-in-browser="true"],
  div#loading-screen.loading-screen[data-show-in-browser="true"] {
    display: flex !important;
    pointer-events: auto !important;
  }
  
  /* High specificity for loading background */
  #loading-screen .loading-bg,
  div#loading-screen .loading-bg {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: 
      radial-gradient(ellipse at 20% 30%, rgba(96, 165, 250, 0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 70%, rgba(168, 85, 247, 0.12) 0%, transparent 50%),
      radial-gradient(ellipse at 40% 90%, rgba(34, 211, 238, 0.1) 0%, transparent 50%) !important;
    animation: bgPulse 4s ease-in-out infinite !important;
    pointer-events: none !important;
  }
  
  @keyframes bgPulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }
  
  /* High specificity for loading content */
  #loading-screen .loading-content,
  div#loading-screen .loading-content {
    position: relative !important;
    z-index: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    gap: 2rem !important;
  }
  
  #loading-screen .loading-logo,
  div#loading-screen .loading-logo {
    position: relative !important;
    width: 120px !important;
    height: 120px !important;
  }
  
  #loading-screen .loading-circle,
  div#loading-screen .loading-circle {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    background: linear-gradient(135deg, #60a5fa 0%, #22d3ee 50%, #a855f7 100%) !important;
    position: relative !important;
    animation: rotate 3s linear infinite !important;
    padding: 4px !important;
  }
  
  #loading-screen .loading-circle::before,
  div#loading-screen .loading-circle::before {
    content: '' !important;
    position: absolute !important;
    inset: -2px !important;
    border-radius: 50% !important;
    background: linear-gradient(135deg, #60a5fa, #22d3ee, #a855f7) !important;
    opacity: 0.5 !important;
    filter: blur(8px) !important;
    animation: rotate 3s linear infinite reverse !important;
  }
  
  #loading-screen .loading-circle-inner,
  div#loading-screen .loading-circle-inner {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    background: #0a0a0a !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  #loading-screen .loading-circle-inner::after,
  div#loading-screen .loading-circle-inner::after {
    content: 'ðŸ¤–' !important;
    font-size: 3rem !important;
    filter: drop-shadow(0 0 10px rgba(96, 165, 250, 0.5)) !important;
  }
  
  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  #loading-screen .loading-pulse,
  div#loading-screen .loading-pulse {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 120px !important;
    height: 120px !important;
    border-radius: 50% !important;
    border: 2px solid rgba(96, 165, 250, 0.3) !important;
    animation: pulse 2s ease-in-out infinite !important;
  }
  
  @keyframes pulse {
    0%, 100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.2);
      opacity: 0;
    }
  }
  
  #loading-screen .loading-text,
  div#loading-screen .loading-text {
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    letter-spacing: 0.1em !important;
    text-transform: uppercase !important;
  }
  
  #loading-screen .loading-text .gradient-text,
  div#loading-screen .loading-text .gradient-text {
    background: linear-gradient(135deg, #60a5fa 0%, #22d3ee 50%, #a855f7 100%) !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-size: 200% 200% !important;
    animation: gradientShift 3s ease infinite !important;
  }
  
  @keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }
  
  #loading-screen .loading-dots,
  div#loading-screen .loading-dots {
    display: flex !important;
    gap: 0.5rem !important;
    align-items: center !important;
  }
  
  #loading-screen .loading-dots .dot,
  div#loading-screen .loading-dots .dot {
    width: 8px !important;
    height: 8px !important;
    border-radius: 50% !important;
    background: linear-gradient(135deg, #60a5fa, #22d3ee) !important;
    animation: dotBounce 1.4s ease-in-out infinite !important;
  }
  
  .loading-dots .dot:nth-child(1) {
    animation-delay: 0s;
  }
  
  .loading-dots .dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  
  .loading-dots .dot:nth-child(3) {
    animation-delay: 0.4s;
  }
  
  @keyframes dotBounce {
    0%, 80%, 100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1.2);
      opacity: 1;
    }
  }
  
  /* Mobile optimizations */
  @media (max-width: 640px) {
    #loading-screen .loading-logo,
    div#loading-screen .loading-logo {
      width: 100px !important;
      height: 100px !important;
    }
    
    #loading-screen .loading-circle-inner::after,
    div#loading-screen .loading-circle-inner::after {
      font-size: 2.5rem !important;
    }
    
    #loading-screen .loading-text,
    div#loading-screen .loading-text {
      font-size: 1.25rem !important;
    }
    
    #loading-screen .loading-dots .dot,
    div#loading-screen .loading-dots .dot {
      width: 6px !important;
      height: 6px !important;
    }
  }
  
  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .loading-circle,
    .loading-circle::before {
      animation: none;
    }
    
    .loading-pulse {
      animation: none;
    }
    
    .loading-text .gradient-text {
      animation: none;
    }
    
    .loading-dots .dot {
      animation: none;
      opacity: 0.7;
    }
    
    .loading-bg {
      animation: none;
    }
  }
</style>

<script is:inline>
  // Auto-hide loading screen after page load
  (function() {
    const loadingScreen = document.getElementById('loading-screen');
    if (!loadingScreen) return;
    
    // Cleanup registry
    const cleanupFunctions = [];
    function registerCleanup(fn) {
      cleanupFunctions.push(fn);
    }
    
    // Check if should show in browser
    const showInBrowser = loadingScreen.getAttribute('data-show-in-browser') === 'true';
    
    // Check for Telegram - wait a bit for Telegram WebApp to initialize
    // Also check for body.tg-webapp class which is added by Base.astro
    function checkTelegram() {
      return typeof window !== 'undefined' && (
        window.Telegram?.WebApp || 
        document.body.classList.contains('tg-webapp')
      );
    }
    
    // Get main content reference first
    const mainContent = document.getElementById('main-content');
    
    // CRITICAL: Check if loading screen was already shown by navigation
    // (Base.astro sets sessionStorage and shows loader before navigation)
    const wasShownByNavigation = sessionStorage.getItem('showLoadingScreen') === 'true';
    
    // Remove sessionStorage flag after checking (cleanup)
    if (wasShownByNavigation) {
      sessionStorage.removeItem('showLoadingScreen');
    }
    
    // CRITICAL: Hide main content initially to prevent white flash
    // It will be shown when loading screen hides
    // BUT: if loader was already shown by navigation, main-content is already hidden
    if (mainContent && !wasShownByNavigation) {
      mainContent.style.visibility = 'hidden';
      mainContent.style.opacity = '0';
    }
    
    // If loader was shown by navigation, it's already visible - skip initialization
    if (wasShownByNavigation) {
      // Loading screen is already visible from Base.astro
      // Just ensure it stays visible until page loads
      loadingScreen.style.display = 'flex';
      loadingScreen.style.visibility = 'visible';
      loadingScreen.style.pointerEvents = 'auto';
      loadingScreen.style.opacity = '1';
    } else {
      // Normal initialization (first page load or direct URL)
      // Wait a bit for Telegram WebApp to initialize (up to 500ms)
      let isTelegram = checkTelegram();
      if (!isTelegram) {
        let retries = 0;
        const checkInterval = setInterval(() => {
          isTelegram = checkTelegram();
          retries++;
          if (isTelegram || retries >= 10) { // 10 * 50ms = 500ms max wait
            clearInterval(checkInterval);
            if (isTelegram) {
              // Show loading screen if in Telegram
              loadingScreen.style.display = 'flex';
              loadingScreen.style.visibility = 'visible';
              loadingScreen.style.pointerEvents = 'auto';
            } else {
              // Not in Telegram and not enabled for browser - show main content immediately
              if (mainContent && !showInBrowser) {
                mainContent.style.visibility = 'visible';
                mainContent.style.display = 'block';
                mainContent.style.opacity = '1';
                mainContent.style.zIndex = '1';
              }
            }
          }
        }, 50);
        registerCleanup(() => clearInterval(checkInterval));
      }
      
      // Don't show in regular browser unless explicitly enabled (for SEO)
      if (!isTelegram && !showInBrowser) {
        // In browser - hide loading screen and show main content immediately
        loadingScreen.style.display = 'none';
        loadingScreen.style.visibility = 'hidden';
        loadingScreen.style.pointerEvents = 'none';
        loadingScreen.style.zIndex = '-1';
        // Ensure main content is visible in browser
        if (mainContent) {
          mainContent.style.visibility = 'visible';
          mainContent.style.display = 'block';
          mainContent.style.opacity = '1';
          mainContent.style.zIndex = '1';
        }
        return;
      }
      
      // In Telegram - ensure loading screen is visible and main content stays hidden
      if (isTelegram) {
        loadingScreen.style.display = 'flex';
        loadingScreen.style.visibility = 'visible';
        loadingScreen.style.pointerEvents = 'auto';
      }
    }
    
    // Hide after page is fully loaded
    function hideLoader() {
      if (loadingScreen && !loadingScreen.classList.contains('loaded')) {
        loadingScreen.classList.add('loaded');
        
        // Show main content when loader hides (prevent white flash)
        if (mainContent) {
          // Use requestAnimationFrame to ensure smooth transition
          requestAnimationFrame(() => {
            mainContent.style.visibility = 'visible';
            mainContent.style.display = 'block';
            mainContent.style.opacity = '1';
            mainContent.style.zIndex = '1';
          });
        }
        
        // Remove from DOM after animation
        const removeTimeout = setTimeout(() => {
          if (loadingScreen && loadingScreen.parentNode) {
            loadingScreen.remove();
          }
          // Cleanup all listeners
          cleanupFunctions.forEach(fn => { try { fn(); } catch (e) {} });
        }, 500);
        registerCleanup(() => clearTimeout(removeTimeout));
      }
    }
    
    // Minimum display time for loading screen (UX best practice - users need to see it)
    const minDisplayTime = 800; // 800ms minimum to ensure visibility
    const startTime = Date.now();
    
    function hideLoaderWithMinTime() {
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, minDisplayTime - elapsed);
      setTimeout(hideLoader, remaining);
    }
    
    // Hide on DOMContentLoaded (but respect minimum display time)
    if (document.readyState === 'loading') {
      const domReadyHandler = hideLoaderWithMinTime;
      document.addEventListener('DOMContentLoaded', domReadyHandler);
      registerCleanup(() => document.removeEventListener('DOMContentLoaded', domReadyHandler));
    } else {
      hideLoaderWithMinTime();
    }
    
    // Fallback: hide after max 2.5 seconds (UX best practice)
    const timeout2 = setTimeout(hideLoader, 2500);
    registerCleanup(() => clearTimeout(timeout2));
    
    // Also hide on window load (but respect minimum display time)
    const loadHandler = hideLoaderWithMinTime;
    window.addEventListener('load', loadHandler);
    registerCleanup(() => window.removeEventListener('load', loadHandler));
  })();
</script>

