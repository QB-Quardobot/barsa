---
import AdminLayout from '../../layouts/AdminLayout.astro';

const API_BASE = import.meta.env.PUBLIC_API_BASE || '/api';
---

<AdminLayout title="Сервер">
  <div class="dashboard-header">
    <h1 class="page-title">Информация о сервере</h1>
    <p class="page-subtitle">Мониторинг ресурсов и управление кэшем</p>
  </div>

  <!-- Статистика сервера -->
  <div class="stats-grid" id="server-stats">
    <div class="premium-card loading-skeleton">
      <div class="stat-label">Диск</div>
      <div class="stat-value">...</div>
    </div>
    <div class="premium-card loading-skeleton">
      <div class="stat-label">Память</div>
      <div class="stat-value">...</div>
    </div>
    <div class="premium-card loading-skeleton">
      <div class="stat-label">CPU</div>
      <div class="stat-value">...</div>
    </div>
    <div class="premium-card loading-skeleton">
      <div class="stat-label">Время работы</div>
      <div class="stat-value">...</div>
    </div>
  </div>

  <!-- Детальная информация -->
  <div class="dashboard-sections">
    <div class="premium-card">
      <div class="card-header">
        <h2 class="card-title">Использование диска</h2>
        <button class="btn-refresh" onclick="fetchServerInfo()" title="Обновить">
          <i data-lucide="refresh-cw"></i>
        </button>
      </div>
      <div id="disk-info" class="info-container">
        <div class="loading-placeholder">Загрузка...</div>
      </div>
    </div>

    <div class="premium-card">
      <div class="card-header">
        <h2 class="card-title">Использование памяти</h2>
      </div>
      <div id="memory-info" class="info-container">
        <div class="loading-placeholder">Загрузка...</div>
      </div>
    </div>

    <div class="premium-card">
      <div class="card-header">
        <h2 class="card-title">Процессор</h2>
      </div>
      <div id="cpu-info" class="info-container">
        <div class="loading-placeholder">Загрузка...</div>
      </div>
    </div>

    <div class="premium-card">
      <div class="card-header">
        <h2 class="card-title">Очистка кэша</h2>
      </div>
      <div class="cleanup-section">
        <p class="cleanup-description">
          Очистка кэша освободит место на диске, удалив временные файлы, старые логи и npm кэш.
        </p>
        <button class="btn-cleanup" onclick="cleanupCache()" id="cleanup-btn">
          <i data-lucide="trash-2"></i>
          Очистить кэш
        </button>
        <div id="cleanup-result" class="cleanup-result"></div>
      </div>
    </div>
  </div>

  <style>
    .dashboard-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }

    .page-subtitle {
      color: var(--text-secondary);
      margin: 0;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .btn-refresh {
      background: rgba(0, 175, 240, 0.1);
      border: 1px solid rgba(0, 175, 240, 0.3);
      color: var(--of-blue);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-refresh:hover {
      background: rgba(0, 175, 240, 0.2);
      border-color: var(--of-blue);
    }

    .info-container {
      margin-top: 16px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--card-border);
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .info-value {
      font-weight: 600;
      font-size: 14px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-ok {
      background: #10b981;
    }

    .progress-warning {
      background: #f59e0b;
    }

    .progress-critical {
      background: #ef4444;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-ok {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .status-warning {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }

    .status-critical {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .cleanup-section {
      margin-top: 16px;
    }

    .cleanup-description {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .btn-cleanup {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-cleanup:hover:not(:disabled) {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
    }

    .btn-cleanup:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .cleanup-result {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .cleanup-result.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      display: block;
    }

    .cleanup-result.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      display: block;
    }

    .loading-placeholder {
      color: var(--text-secondary);
      text-align: center;
      padding: 40px;
    }

    .loading-skeleton {
      opacity: 0.6;
      animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 0.3; }
      100% { opacity: 0.6; }
    }
  </style>

  <script define:vars={{ apiBase: API_BASE }}>
    const API_BASE = apiBase;
    const adminFetch = window.adminFetch || fetch;
    const ensureAdminAuth = window.ensureAdminAuth || (async () => true);

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function getStatusClass(status) {
      return {
        'ok': 'status-ok',
        'warning': 'status-warning',
        'critical': 'status-critical'
      }[status] || 'status-ok';
    }

    function getProgressClass(status) {
      return {
        'ok': 'progress-ok',
        'warning': 'progress-warning',
        'critical': 'progress-critical'
      }[status] || 'progress-ok';
    }

    async function fetchServerInfo() {
      try {
        const authed = await ensureAdminAuth();
        if (!authed) return;
        const response = await adminFetch(`${API_BASE}/admin/server-info`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        
        // Обновляем статистику
        const statsGrid = document.getElementById('server-stats');
        if (statsGrid) {
          statsGrid.innerHTML = `
            <div class="premium-card">
              <div class="stat-label">Диск</div>
              <div class="stat-value">${data.disk.free_gb.toFixed(1)} GB</div>
              <div class="stat-subtitle">свободно из ${data.disk.total_gb.toFixed(1)} GB</div>
            </div>
            <div class="premium-card">
              <div class="stat-label">Память</div>
              <div class="stat-value">${data.memory.free_gb.toFixed(1)} GB</div>
              <div class="stat-subtitle">свободно из ${data.memory.total_gb.toFixed(1)} GB</div>
            </div>
            <div class="premium-card">
              <div class="stat-label">CPU</div>
              <div class="stat-value">${data.cpu.percent.toFixed(1)}%</div>
              <div class="stat-subtitle">${data.cpu.count} ядер</div>
            </div>
            <div class="premium-card">
              <div class="stat-label">Время работы</div>
              <div class="stat-value">${data.uptime.formatted}</div>
              <div class="stat-subtitle">без перезагрузки</div>
            </div>
          `;
        }

        // Диск
        const diskInfo = document.getElementById('disk-info');
        if (diskInfo) {
          diskInfo.innerHTML = `
            <div class="info-item">
              <span class="info-label">Всего</span>
              <span class="info-value">${data.disk.total_gb.toFixed(2)} GB</span>
            </div>
            <div class="info-item">
              <span class="info-label">Использовано</span>
              <span class="info-value">${data.disk.used_gb.toFixed(2)} GB (${data.disk.percent.toFixed(1)}%)</span>
            </div>
            <div class="info-item">
              <span class="info-label">Свободно</span>
              <span class="info-value">${data.disk.free_gb.toFixed(2)} GB</span>
            </div>
            <div class="info-item">
              <span class="info-label">Статус</span>
              <span class="status-badge ${getStatusClass(data.disk.status)}">${data.disk.status}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill ${getProgressClass(data.disk.status)}" style="width: ${data.disk.percent}%"></div>
            </div>
          `;
        }

        // Память
        const memoryInfo = document.getElementById('memory-info');
        if (memoryInfo) {
          memoryInfo.innerHTML = `
            <div class="info-item">
              <span class="info-label">Всего</span>
              <span class="info-value">${data.memory.total_gb.toFixed(2)} GB</span>
            </div>
            <div class="info-item">
              <span class="info-label">Использовано</span>
              <span class="info-value">${data.memory.used_gb.toFixed(2)} GB (${data.memory.percent.toFixed(1)}%)</span>
            </div>
            <div class="info-item">
              <span class="info-label">Свободно</span>
              <span class="info-value">${data.memory.free_gb.toFixed(2)} GB</span>
            </div>
            <div class="info-item">
              <span class="info-label">Статус</span>
              <span class="status-badge ${getStatusClass(data.memory.status)}">${data.memory.status}</span>
            </div>
            ${data.swap.total_gb > 0 ? `
            <div class="info-item">
              <span class="info-label">Swap</span>
              <span class="info-value">${data.swap.used_gb.toFixed(2)} / ${data.swap.total_gb.toFixed(2)} GB (${data.swap.percent.toFixed(1)}%)</span>
            </div>
            ` : ''}
            <div class="progress-bar">
              <div class="progress-fill ${getProgressClass(data.memory.status)}" style="width: ${data.memory.percent}%"></div>
            </div>
          `;
        }

        // CPU
        const cpuInfo = document.getElementById('cpu-info');
        if (cpuInfo) {
          cpuInfo.innerHTML = `
            <div class="info-item">
              <span class="info-label">Использование</span>
              <span class="info-value">${data.cpu.percent.toFixed(1)}%</span>
            </div>
            <div class="info-item">
              <span class="info-label">Ядра</span>
              <span class="info-value">${data.cpu.count}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Частота</span>
              <span class="info-value">${data.cpu.freq_mhz.toFixed(0)} MHz</span>
            </div>
            <div class="info-item">
              <span class="info-label">Загрузка (1/5/15 мин)</span>
              <span class="info-value">${data.cpu.load_avg.join(' / ')}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Статус</span>
              <span class="status-badge ${getStatusClass(data.cpu.status)}">${data.cpu.status}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill ${getProgressClass(data.cpu.status)}" style="width: ${data.cpu.percent}%"></div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error fetching server info:', error);
        const statsGrid = document.getElementById('server-stats');
        if (statsGrid) {
          statsGrid.innerHTML = `
            <div class="premium-card">
              <div class="stat-label">Ошибка</div>
              <div class="stat-value" style="color: #ef4444;">Не удалось загрузить данные</div>
            </div>
          `;
        }
      }
    }

    async function cleanupCache() {
      const btn = document.getElementById('cleanup-btn');
      const result = document.getElementById('cleanup-result');
      
      if (!btn || !result) return;

      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader"></i> Очистка...';
      result.className = 'cleanup-result';
      result.textContent = '';
      
      if (window.lucide && typeof window.lucide.createIcons === 'function') {
        // @ts-ignore
        window.lucide.createIcons();
      }

      try {
        const authed = await ensureAdminAuth();
        if (!authed) return;
        const response = await adminFetch(`${API_BASE}/admin/cleanup-cache`, {
          method: 'POST'
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();

        if (data.success) {
          result.className = 'cleanup-result success';
          const freed = data.results.freed_space_mb > 0 
            ? ` Освобождено: ${data.results.freed_space_mb.toFixed(2)} MB`
            : '';
          result.innerHTML = `
            <strong>✓ Очистка завершена!</strong><br>
            Очищено: ${data.results.cleaned.join(', ')}${freed}
            ${data.results.errors.length > 0 ? `<br><small>Ошибки: ${data.results.errors.join(', ')}</small>` : ''}
          `;
          
          // Обновляем информацию о сервере
          setTimeout(fetchServerInfo, 1000);
        } else {
          throw new Error(data.message || 'Ошибка очистки');
        }
      } catch (error) {
        result.className = 'cleanup-result error';
        result.innerHTML = `<strong>✗ Ошибка:</strong> ${error.message || 'Не удалось очистить кэш'}`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="trash-2"></i> Очистить кэш';
        // @ts-ignore
        lucide.createIcons();
      }
    }

    // Инициализация
    fetchServerInfo();
    
    // Автообновление каждые 30 секунд
    setInterval(fetchServerInfo, 30000);
    
    // Инициализация иконок
    if (window.lucide && typeof window.lucide.createIcons === 'function') {
      // @ts-ignore
      window.lucide.createIcons();
    }
  </script>
</AdminLayout>
