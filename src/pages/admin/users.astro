---
import AdminLayout from '../../layouts/AdminLayout.astro';

const API_BASE = import.meta.env.PUBLIC_API_BASE || '/api';
---

<AdminLayout title="Пользователи">
  <div class="dashboard-header">
    <h1 class="page-title">Пользователи бота</h1>
    <p class="page-subtitle">Все пользователи, запустившие Telegram бота</p>
  </div>

  <div class="premium-card">
    <div class="table-container">
      <table class="premium-table" id="users-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Имя</th>
            <th>Фамилия</th>
            <th>Дата регистрации</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">
              Загрузка данных...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <style>
    .dashboard-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }

    .page-subtitle {
      color: var(--text-secondary);
      margin: 0;
    }

    .table-container {
      overflow-x: auto;
    }
  </style>

  <script define:vars={{ apiBase: API_BASE }}>
    const API_BASE = apiBase;
    
    function waitForAdminHelpers() {
      return new Promise((resolve) => {
        if (window.ensureAdminAuth && window.adminFetch) {
          resolve(true);
          return;
        }
        let attempts = 0;
        const interval = setInterval(() => {
          attempts += 1;
          if (window.ensureAdminAuth && window.adminFetch) {
            clearInterval(interval);
            resolve(true);
          } else if (attempts >= 40) {
            clearInterval(interval);
            resolve(false);
          }
        }, 50);
      });
    }

    async function fetchUsers() {
      try {
        await waitForAdminHelpers();
        const ensureAdminAuth = window.ensureAdminAuth || (async () => false);
        const adminFetch = window.adminFetch || fetch;
        const authed = await ensureAdminAuth();
        if (!authed) return;
        const response = await adminFetch(`${API_BASE}/admin/users`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        
        const tableBody = document.querySelector('#users-table tbody');
        if (tableBody) {
          if (!Array.isArray(data)) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">Ошибка загрузки данных</td></tr>`;
            return;
          }
          if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">Пользователей пока нет</td></tr>`;
            return;
          }

          tableBody.innerHTML = data.map(user => `
            <tr>
              <td data-label="ID" style="font-family: monospace; font-size: 13px;">${user.user_id}</td>
              <td data-label="Username">${user.username ? `@${user.username}` : '-'}</td>
              <td data-label="Имя">${user.name || '-'}</td>
              <td data-label="Фамилия">${user.surname || '-'}</td>
              <td data-label="Дата регистрации">${user.reg_date || '-'}</td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Error fetching users:', error);
        const tableBody = document.querySelector('#users-table tbody');
        if (tableBody) {
          tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">Ошибка загрузки данных</td></tr>`;
        }
      }
    }

    async function initAdmin() {
      await waitForAdminHelpers();
      await fetchUsers();
    }

    initAdmin();
  </script>
</AdminLayout>
